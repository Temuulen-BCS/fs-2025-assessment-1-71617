@using BikeStation.UI.Models
@using Microsoft.AspNetCore.Components

@if (Stations == null)
{
    <p>Loading...</p>
}
else if (!Stations.Any())
{
    <p>No stations found.</p>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Address</th>
                <th>Bikes</th>
                <th>Stands</th>
                <th>Status</th>
                <th>Occupancy</th>
                <th>Last Update</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in Stations)
            {
                <tr class="@GetRowClass(s)" @onclick="@(() => Select(s.Number))" style="cursor: pointer;">
                    <td>@s.Number</td>
                    <td>@s.Name</td>
                    <td>@s.Address</td>
                    <td>@s.AvailableBikes</td>
                    <td>@s.BikeStands</td>
                    <td>@s.Status</td>
                    <td>@s.Occupancy.ToString("P0")</td>
                    <td>@s.LastUpdateLocal.ToLocalTime().ToString("g")</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                @onclick:stopPropagation="true"
                                @onclick="@(() => Select(s.Number))">
                            Details
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter] public IReadOnlyList<StationDto>? Stations { get; set; }
    [Parameter] public int? SelectedNumber { get; set; }
    [Parameter] public EventCallback<int?> SelectedNumberChanged { get; set; }
    [Parameter] public EventCallback<int> OnSelect { get; set; }

    private string GetRowClass(StationDto s)
    {
        if (SelectedNumber.HasValue && SelectedNumber.Value == s.Number)
            return "table-primary";
        return string.Empty;
    }

    private async Task Select(int number)
    {
        if (SelectedNumberChanged.HasDelegate)
            await SelectedNumberChanged.InvokeAsync(number);

        if (OnSelect.HasDelegate)
            await OnSelect.InvokeAsync(number);
    }
}
